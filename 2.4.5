SELECT buy_step.buy_id, 
       DATEDIFF(buy_step.date_step_end, buy_step.date_step_beg) AS Количество_дней, 
       GREATEST(DATEDIFF(buy_step.date_step_end, buy_step.date_step_beg)-city.days_delivery, 0) AS Опоздание
FROM city
    INNER JOIN client USING(city_id)
    INNER JOIN buy USING(client_id)
    INNER JOIN buy_step USING(buy_id)
    INNER JOIN step USING(step_id)
WHERE step.step_id = 3 AND buy_step.date_step_end IS NOT NULL;
#тяжело но интересно
